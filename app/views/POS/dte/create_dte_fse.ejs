<!DOCTYPE html>
<html lang="es">

<head>
  <%- include('../../Layouts/Head.ejs') %>
  <link rel="stylesheet" href="assets/libs/choices/choices.min.css">
</head>

<body class="<%= darkMode %>">
  <%- include('../../Layouts/SideBar.ejs') %>
  <div id="main">
    <%- include('../../Layouts/NavBar.ejs') %>

    <div class="container-fluid">
      <div class="card">
        <div class="card-header">
          <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">Factura de Sujeto Excluido(DTE Manual)</h2>
        </div>
        <div class="card-body">
          <!-- NIT y NRC en una fila -->
          <h4 class="text-center">Datos del Receptor</h4>
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="tipoDocumento" class="form-label">Tipo Documento:</label>
                <select name="tipoDocumento" id="tipoDocumento" class="form-control">
                  <option value="">Ninguno</option>
                  <option value="13">DUI</option>
                  <option value="36">NIT</option>
                  <option value="37">Otro</option>
                  <option value="03">Pasaporte</option>
                  <option value="02">Carnet de Residente</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="numDocumento" class="form-label">Numero Documento:</label>
                <input type="text" class="form-control" id="numDocumento" placeholder="con Guiones">
              </div>
            </div>

          </div>

          <div class="form-group">
            <label for="nombre" class="form-label"> <strong class="text-danger" style="font-size: 150%;">*</strong> Nombre:</label>
            <input type="text" class="form-control" id="nombre" placeholder="Ingrese nombre completo o razón social" required>
          </div>




          <div class="row">

            <div class="form-group mb-3 col-md-12">
              <label for="clientCodActividad">Giro, Actividad Economica del Contribuyente</label>
              <select class="form-control" id="clientCodActividad" type="text" placeholder="">
                <option value="">Seleccione la Actividad Economica del Contribuyente</option>
                <% giros.forEach(element => { %>
                <option value="<%= element.codigo %>"><%= element.Valor %></option>
                <% }) %>
              </select>
            </div>
          </div>
          <!-- Teléfono y Correo -->
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="telefono" class="form-label">Teléfono:</label>
                <input type="text" class="form-control" id="telefono" placeholder="Ingrese teléfono">
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="correo" class="form-label">Correo:</label>
                <input type="email" class="form-control" id="correo" placeholder="Ingrese correo electrónico">
              </div>
            </div>
          </div>

          <h5>Dirección del Cliente</h5>

          <div class="form-group">
            <label for="distrito">Seleccione el Distrito</label>
            <select name="distrito" id="distrito" class="form-control">
              <option value="">Ninguno</option>
            </select>
          </div>

          <div class="form-group">
            <label for="departamento">Departamento</label>
            <select name="departamento" id="departamento" class="form-control" disabled>
              <option value="" selected>Sin Dirección</option>
              <% departamentos.forEach(element => { %>
              <option value="<%= element.codigo %>"><%= element.Valor %></option>
              <% }) %>
            </select>
          </div>

          <div class="form-group">
            <label for="municipio">Municipio</label>
            <select name="municipio" id="municipio" class="form-control" disabled>
              <option value="" selected>Sin Dirección</option>
            </select>
          </div>

          <div class="form-group">
            <label for="complemento">Complemento de la Direccion:</label>
            <input type="text" name="complemento" id="complemento" class="form-control">
          </div>
        </div>


        <div class="card-body">
          <h4 class="text-center">
            Detalles del Cuerpo del Documento
          </h4>

          <div class="form-group mt-5 mb-5">
            <label for="gravamen">Tipo de Impuesto</label>
            <select name="gravamen" id="gravamen" class="form-control">
              <option value="0" >0% Compra de otros Articulos</option>
              <option value="10" selected>10% Servicios Profesionales</option>
              <option value="13" disbled>13% Leche cruda, carnes y otros art 162 Cod Tributario</option>
            </select>
          </div>
          <div class="table-responsive mb-4 table-responsive">
            <table class="table table-sm table-bordered table-striped">
              <thead>
                <tr>
                  <th scope="col" style="max-width: 30%;width: 30%;">Descripción</th>
                  <th scope="col" style="max-width: 140px;width: 140px;">Cantidad</th>
                  <th scope="col" style="max-width: 140px;width: 140px;">Precio Unitario</th>
                  <th>Subtotal</th>
                  <th scope="col" style="max-width: 140px;width: 140px;">Código</th>
                  <th scope="col" style="max-width: 140px;width: 140px;">Tipo de Ítem</th>
                  <th scope="col" style="max-width: 140px;width: 140px;">Unidad de Medida</th>
                  <th scope="col">Acciones</th>
                </tr>
              </thead>
              <tbody id="documentoDetalleTableBody">
                <!-- Filas de detalles se agregarán aquí dinámicamente -->
              </tbody>
              <tbody id="detalleTotales">
                <tr>
                  <td colspan="3" class="text-right">Subtotal Compra</td>
                  <td id="_subtotal"></td>
                  <td colspan="4"></td>
                </tr>

                <tr>
                  <td colspan="3" class="text-right">Retencion Iva</td>
                  <td id="_ret_iva"></td>
                  <td colspan="4"></td>
                </tr>

                <tr>
                  <td colspan="3" class="text-right">Retencion Renta</td>
                  <td id="_ret_renta"></td>
                  <td colspan="4"></td>
                </tr>
                <tr>
                  <td colspan="3" class="text-right">Total</td>
                  <td id="_total"></td>
                  <td colspan="4"></td>
                </tr>
              </tbody>
              <tfoot>
                <tr>
                  <td colspan="8" class="text-center">
                    <button type="button" class="btn btn-outline-primary mr-3 mt-3 ml-3 round" id="addDetalleBtn">Agregar Ítem</button>
                    <button type="button" class="btn btn-outline-success mr-3 mt-3 ml-3 round" id="Totalizar">Totalizar</button>
                  </td>
                </tr>

              </tfoot>
            </table>
          </div>
        </div>

        <div class="card-body">
          <h4>Apendices</h4>
          <div class="table-responsive">
            <table class="table table-sm table-bordered table-hover">
              <thead>
                <tr>
                  <th>Campo</th>
                  <th>Etiqueta</th>
                  <th>Valor</th>
                  <th>opt</th>
                </tr>
              </thead>
              <tbody id="TBodyApendices">


              </tbody>
              <tfoot>
                <tr>
                  <td colspan="4" class="text-center">
                    <button class="btn round btn-outline-primary" onclick="addApendiceRow()" id="btnAddApendices">
                      Agregar Apendice
                    </button>
                  </td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

        <div class="card-footer text-center">
          <div id="results" class="mt-2 mb-4">


          </div>
          <button class="round btn-lg btn btn-primary mt-2" id="btnSave" disabled>
            Procesar DTE
          </button>
        </div>

      </div>
    </div>

    <%- include('../../Layouts/Footer.ejs') %>
  </div>
</body>
<%- include('../../Layouts/Scripts.ejs') %>
<script src="assets/libs/choices/choices.min.js"></script>
<script>
  const documentoDetalleTableBody = document.querySelector("#documentoDetalleTableBody");

  const TBodyApendices = document.querySelector("#TBodyApendices");
  const addDetalleBtn = document.querySelector('#addDetalleBtn');

  const btnAddApendices = document.querySelector('#btnAddApendices');
  const IVA_VAL = Number.parseFloat('<%= VALOR_IVA %>');
  const helper_url = '<%= helper_url %>';
  var distritos = '<%- dptos %>';
  const departamentos = JSON.parse(distritos);
  var selected_departamento = null;
  var selected_municipio = null;
  distritos = '<%- dis %>';
  distritos = JSON.parse(distritos);

  const cargarMunicipios = (index) => {
    let muni = departamentos[index];
    document.querySelector("#municipio").innerHTML = '';
    muni.forEach(element => {
      document.querySelector("#municipio").innerHTML += `<option value="${element.codigo}">${element.Valor}</option>`;
    });

  }

  const subtotalizar = node => {
    let cant = Number.parseInt(node.querySelector('.cantidad-item').value);
    let price = Number.parseFloat(node.querySelector('.precio-uni-item').value);
    node.querySelector(".subtotal-td").innerHTML = isNaN(cant) || isNaN(price) ? '$ 0.00' : `$ ${money_format(cant * price)}`;

  }

  const addDetalleRow = () => {

    document.querySelector("#btnSave").disabled = true;
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
                <td>
                    <input type="text" class="form-control descripcion-item" placeholder="Descripción" required>
                </td>
                <td>
                    <input type="number" class="form-control cantidad-item" oninput="subtotalizar(this.parentNode.parentNode)" placeholder="Cantidad" min="0" step="any" required>
                </td>
                <td>
                    <input type="number" class="form-control precio-uni-item" oninput="subtotalizar(this.parentNode.parentNode)" placeholder="Precio Uni." min="0" step="0.01" required>
                </td>
                <td class="subtotal-td">
                    
                </td>
                <td>
                    <input type="text" class="form-control codigo-item" placeholder="Código">
                </td>
                <td>
                    <select class="form-select tipo-item" required>
                        <option value="1">Bienes</option>
                        <option value="2">Servicios</option>
                        <option value="3">Ambos (incluye bienes y servicios, incluye los dos inherente a los Productos o Servicios</option>
                    </select>
                </td>
                <td>
                    <select class="form-select uni-medida-item" required>
                      <option value="59">Unidad</option>
                      <option value="13">metro cuadrado</option>
                      <option value="15">Vara cuadrada</option>
                      <option value="18">metro cúbico</option>
                      <option value="20">Barril</option>
                      <option value="22">Galón</option>
                      <option value="23">Litro</option>
                      <option value="24">Botella</option>
                      <option value="26">Mililitro</option>
                      <option value="30">Tonelada</option>
                      <option value="32">Quintal</option>
                      <option value="33">Arroba</option>
                      <option value="34">Kilogramo</option>
                      <option value="36">Libra</option>
                      <option value="37">Onza troy</option>
                      <option value="38">Onza</option>
                      <option value="39">Gramo</option>
                      <option value="40">Miligramo</option>
                      <option value="42">Megawatt</option>
                      <option value="43">Kilowatt</option>
                      <option value="44">Watt</option>
                      <option value="45">Megavoltio-amperio</option>
                      <option value="46">Kilovoltio-amperio</option>
                      <option value="47">Voltio-amperio</option>
                      <option value="49">Gigawatt-hora</option>
                      <option value="50">Megawatt-hora</option>
                      <option value="51">Kilowatt-hora</option>
                      <option value="52">Watt-hora</option>
                      <option value="53">Kilovoltio</option>
                      <option value="54">Voltio</option>
                      <option value="55">Millar</option>
                      <option value="56">Medio millar</option>
                      <option value="57">Ciento</option>
                      <option value="58">Docena</option>
                      <option value="99">Otra</option>
                    </select>
                </td>
                <td>
                    <span class="badge bg-danger btn-sm remove-item-btn">Eliminar</span>
                </td>
            `;
    // Añadir el event listener para el botón de eliminar de la nueva fila
    newRow.querySelector('.remove-item-btn').addEventListener('click', function() {
      newRow.remove(); // Elimina la fila del DOM
    });
    documentoDetalleTableBody.appendChild(newRow);
  }



  const addApendiceRow = () => {
    const newApendiceRow = document.createElement('tr');
    newApendiceRow.innerHTML = `
                <td>
                    <input type="text" class="form-control apendice-campo">
                  </td>
                  <td>
                    <input type="text" class="form-control apendice-etiqueta">
                  </td>
                  <td>
                    <input type="text" class="form-control apendice-valor">
                  </td>
                  <td>
                    <span class="bg-danger badge btn-delete-apendice">
                      Eliminar
                    </span>
                  </td>
            `;

    // Añadir el event listener para el botón de eliminar de la nueva fila
    newApendiceRow.querySelector('.btn-delete-apendice').addEventListener('click', function() {
      newApendiceRow.remove(); // Elimina la fila del DOM
    });
    TBodyApendices.appendChild(newApendiceRow);



  }

  document.addEventListener('DOMContentLoaded', event => {

    document.querySelector("#Totalizar").addEventListener('click', e => {
      let rows = documentoDetalleTableBody.querySelectorAll('tr');
      if (rows.length < 1) {
        return errorMessage('Agregue al menos un detalle valido al cuerpo del documento');
      }
      var sub = 0,
        iva = 0,
        renta = 0,
        contador = 0;

      rows.forEach(row => {
        const cantidad = parseFloat(row.querySelector('.cantidad-item').value);
        const precioUni = parseFloat(row.querySelector('.precio-uni-item').value);
        if (!isNaN(cantidad) && !isNaN(precioUni)) {
          contador++;
          sub = fix_number(sub + (cantidad * precioUni));
        }
      });

      if(document.querySelector('#gravamen').value == "10"){
            renta = fix_number(sub * 0.10);
      }if(document.querySelector('#gravamen').value == "13"){
            iva = fix_number(sub * IVA_VAL);
      }


      if (contador < 1) {
        return errorMessage('Agregue al menos un detalle valido al cuerpo del documento');
      }
      document.querySelector("#_subtotal").innerHTML = `$ ${money_format(sub)}`;
      document.querySelector("#_ret_iva").innerHTML = `$ ${money_format(iva)}`;
      document.querySelector("#_ret_renta").innerHTML = `$ ${money_format(renta)}`;
      document.querySelector("#_total").innerHTML = `$ ${money_format(sub-renta-iva)}`;
      document.querySelector("#btnSave").disabled = false;
    });


    document.querySelector("#btnSave").addEventListener('click', e => {
      e.target.disabled = true;
      var cuerpoDocumento = [];
      var pagos = null;
      let retencion = document.querySelector('#gravamen').value === "10";

      let subtotal = 0.00;
      const clientCodActividad = document.getElementById('clientCodActividad');

      const nombre = document.getElementById('nombre').value.trim();


      const tipoDocumento = document.getElementById('tipoDocumento').value;
      var numDocumento = document.getElementById('numDocumento').value;
      if (tipoDocumento == "36" || tipoDocumento == "13") {
        numDocumento = numDocumento.replace(/[^0-9]/g, '');
      }


      var receptor = {
        tipoDocumento: tipoDocumento,
        numDocumento: numDocumento,
        nombre: nombre,
        codActividad: null,
        descActividad: null,
        direccion: document.querySelector("#distrito").value !== "" ? {
          departamento: document.getElementById('departamento').value,
          municipio: document.getElementById('municipio').value,
          complemento: `Distrito de ${document.querySelector("#distrito").value}, ${document.getElementById('complemento').value}`
        } : null,
        telefono: document.getElementById('telefono').value.length > 7 ? document.getElementById('telefono').value : null,
        correo: document.getElementById('correo').value.length > 5 ? document.getElementById('correo').value : null
      };



      const rows = documentoDetalleTableBody.querySelectorAll('tr');
      if (rows.length < 0) {
        return errorMessage('Agregue al menos un detalle valido al cuerpo del documento');
      }
      contador = 1;
      var suma_compra = 0;

      rows.forEach(row => {
        const codigo = row.querySelector('.codigo-item').value;
        const descripcion = row.querySelector('.descripcion-item').value;
        const tipoItem = Number.parseInt(row.querySelector('.tipo-item').value);
        const uniMedida = Number.parseInt(row.querySelector('.uni-medida-item').value);
        const cantidad = Number.parseFloat(row.querySelector('.cantidad-item').value);
        const precioUni = Number.parseFloat(row.querySelector('.precio-uni-item').value);

        // Solo agregar si la descripción y la cantidad son válidas (puedes ajustar esta validación)
        if (descripcion && !isNaN(cantidad) && tipoItem && uniMedida && !isNaN(precioUni)) {
          let compra_ = fix_number(precioUni * cantidad);
          cuerpoDocumento.push({
            numItem: contador,
            tipoItem: tipoItem,
            cantidad: cantidad,
            codigo: codigo || null, // Permitir null si está vacío
            uniMedida: uniMedida,
            descripcion: descripcion,
            precioUni: precioUni,
            montoDescu: 0,
            compra: compra_,
          });

          contador++;
          suma_compra = fix_number(suma_compra + compra_, 2);
        }
      });

      retencion = retencion ? fix_number(suma_compra * 0.10) : 0;

      const resumen = {
        totalCompra: suma_compra,
        descu: 0,
        totalDescu: 0,
        subTotal: suma_compra,
        ivaRete1: 0,
        reteRenta: retencion,
        totalPagar: fix_number(suma_compra - retencion),
        totalLetras: String(money_to_string(fix_number(suma_compra - retencion))).toLocaleUpperCase(),
        condicionOperacion: 1,
        pagos: null,
        observaciones: null
      }

      var apendices = null;

      let ApendiceRows = TBodyApendices.querySelectorAll('tr');
      if (ApendiceRows.length > 0) {
        apendices = [];
        ApendiceRows.forEach(row => {
          let apendice = {
            campo: row.querySelector('.apendice-campo').value.trim(),
            etiqueta: row.querySelector('.apendice-etiqueta').value.trim(),
            valor: row.querySelector('.apendice-valor').value.trim(),
          }

          if (apendice.campo.length > 0 && apendice.valor.length > 0) {
            apendices.push(apendice);
          }
        });

        apendices = apendices.length > 0 ? apendices : null;
      }

      let data = {
        'dte_type': '14',
        "sujetoExcluido": receptor,
        "cuerpoDocumento": cuerpoDocumento,
        "resumen": resumen,
        "apendice": apendices,
      }

      postData('/pos/procces_dte_manual', data).then(data => {
        if (data.status == 'success') {
          document.querySelector("#results").innerHTML = `
          <h4> DTE: ${data.json.codigo} generada con exito</h4>
          <a href="${helper_url}/utils/services/dte/inline?uuid=${data.json.dte.identificacion.codigoGeneracion}&fecha=${data.json.dte.identificacion.fecEmi}" target="_blank" class="btn round btn-outline-secondary">Ver DTE</a>
          <a href="/pos/getJson/${data.json.id}" target="_blank" class="btn round btn-outline-secondary ml-2 mr-2">Descargar DTE.json</a>`;

          e.target.remove();
          successMessage(data.message);
        } else if (data.status == 'errorMessage') {
          e.target.disabled = false;
          return errorMessage(data.message);
        } else {
          return errorMessage('Lo sentimos, ha ocurrido un error, por favor recarga la página he inténtalo nuevamente');
        }

      });

    });

    document.querySelector("#departamento").addEventListener('change', e => {
      cargarMunicipios(document.querySelector("#departamento").value);
    });

    document.querySelector("#distrito").addEventListener('choice', e => {
      let option = e.detail.choice;
      if (option.value == '') {
        document.querySelector("#municipio").innerHTML += `<option value="00" selected>Otro (Para extranjeros)</option>`;
        document.querySelector("#departamento").value = '00';
        selected_departamento = null;
        selected_municipio = null;
      } else if (option.value == '00') {
        selected_departamento = '00';
        selected_municipio = '00';
        cargarMunicipios('00');
        document.querySelector("#municipio").value = '00';
        document.querySelector("#departamento").value = '00';
      } else {
        selected_departamento = option.customProperties.departamento;
        selected_municipio = option.customProperties.municipio;
        cargarMunicipios(option.customProperties.departamento);
        document.querySelector("#municipio").value = option.customProperties.municipio;
        document.querySelector("#departamento").value = option.customProperties.departamento;
      }
    });

    const choices_distrito = new Choices(document.querySelector('#distrito'), {
      'searchChoices': true,
    }).setChoices(distritos);

    const choices_actividad = new Choices(document.querySelector('#clientCodActividad'), {
      'searchChoices': true,
    });
    addDetalleRow();
    addDetalleBtn.addEventListener('click', addDetalleRow);
  });
</script>

</html>



<!-- Font Awesome para iconos -->